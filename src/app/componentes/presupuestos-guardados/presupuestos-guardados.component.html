<!--div class="saved-budgets-card">
  <div class="saved-budgets-header">
    <div>

      <span class="capacity-chip">{{ totalGuardados }}/{{ maxItems }} disponibles</span>
    </div>
    <div class="save-controls">
      <input
        class="form-control"
        type="text"
        [(ngModel)]="nombreTemporal"
        placeholder="Nombre del presupuesto"
      />
      <button class="btn btn-primary" (click)="guardarPresupuestoActual()" [disabled]="!puedeGuardar">
        Guardar presupuesto
      </button>
    </div>
    <small *ngIf="!tareasActuales.length" class="text-muted">
      Agrega tareas para poder guardar este presupuesto.
    </small>
    <small *ngIf="limiteAlcanzado" class="text-danger">
      Has alcanzado el máximo de {{ maxItems }} presupuestos guardados. Elimina alguno para guardar uno nuevo.
    </small>
  </div>

  <div class="filter-wrapper" *ngIf="presupuestosFiltrados.length || filtro">
    <input
      type="text"
      class="form-control filter-input"
      [(ngModel)]="filtro"
      placeholder="Buscar por nombre, empresa o cliente"
    />
  </div>

  <ng-container *ngIf="presupuestosFiltrados.length; else noBudgetsTemplate">
    <div class="saved-budgets-list">
      <div class="saved-budget-item" *ngFor="let presupuesto of presupuestosFiltrados">
        <div class="saved-budget-info">
          <strong>{{ presupuesto.name }}</strong>
          <small>Creado {{ presupuesto.createdAt | date: 'short' }}</small>
          <div class="text-muted small">
            <span>Empresa: {{ presupuesto.empresa?.name || 'Sin empresa' }}</span> |
            <span>Cliente: {{ presupuesto.cliente?.name || 'Sin cliente' }}</span> |
            <span>Tareas: {{ presupuesto.tareas.length }}</span>
          </div>
        </div>
        <div class="saved-budget-actions">
          <button class="btn btn-outline-primary btn-sm" (click)="cargar(presupuesto)">CARGAR</button>
          <button class="btn btn-outline-danger btn-sm" (click)="eliminar(presupuesto)">ELIMINAR</button>
          <button class="btn btn-outline-secondary btn-sm" (click)="descargarPDF(presupuesto)">DESCARGAR COMO PDF</button>
        </div>
      </div>
    </div>
  </ng-container>
</!--div>

<ng-template-- #noBudgetsTemplate>
  <div class="empty-state">
    Todavía no hay presupuestos guardados.
  </div>
</ng-template-->

<div class="saved-budgets-card">
  <div class="saved-budgets-header">
   
    <div class="save-controls">
      <input
        class="form-control"
        type="text"
        [(ngModel)]="nombreTemporal"
        placeholder="Nombre del presupuesto"
      />
      <button
        class="btn btn-primary"
        (click)="guardarPresupuestoActual()"

        [disabled]="!puedeGuardarr"
        [title]="!puedeGuardarr ? getMensajeBotonDeshabilitado() : 'Guardar presupuesto'"
      >
        Guardar
      </button>
       <div>
      <span class="capacity-chip">{{ totalGuardados }}/{{ maxItems }} disponibles</span>
    </div>
    </div>

    @if (nombreTemporal.trim() && nombreYaExiste(nombreTemporal)) {
  <small class="text-danger">
    Ya existe un presupuesto con este nombre. Elige otro.
  </small>
}

    @if (!tareasActuales.length) {
      <small class="text-muted">
        Agrega tareas para poder guardar este presupuesto.
      </small>
    }

    @if (limiteAlcanzado) {
      <small class="text-danger">
        Has alcanzado el máximo de {{ maxItems }} presupuestos guardados. Elimina alguno para guardar uno nuevo.
      </small>
    }
  </div>


  @if (presupuestosFiltrados.length || filtro) {
    <div class="filter-wrapper">
      <input
        type="text"
        class="form-control filter-input"
        [(ngModel)]="filtro"
        placeholder="Buscar por nombre o cliente"
      />
    </div>
  }


  @if (presupuestosFiltrados.length > 0) {
    <div class="saved-budgets-list">
      @for (presupuesto of presupuestosFiltrados; track presupuesto.id) {
        <div class="saved-budget-item">
          <div class="saved-budget-info">
            <strong>{{ presupuesto.name }}</strong>
            <small>Creado {{ presupuesto.createdAt | date: 'short' }}</small>
           <div class="text-muted small">
          <span>Empresa: {{ empresaActual?.name || 'Sin empresa' }}</span> |
          <span>Cliente: {{ presupuesto.cliente.name || 'Sin cliente' }}</span> |
          <span>Tareas: {{ presupuesto.tareas.length || 0 }}</span>
        </div>
          </div>
          <div class="saved-budget-actions">
            <button class="btn btn-outline-primary btn-sm" (click)="cargar(presupuesto)">
              CARGAR
            </button>
            <button (click)="editarPresupuesto(presupuesto)" class="btn btn-warning">
             ✏️ Editar
           </button>
            <button class="btn btn-outline-danger btn-sm" (click)="eliminar(presupuesto)">
              ELIMINAR
            </button>
            <button class="btn btn-outline-secondary btn-sm" (click)="descargarPDF(presupuesto)">
              DESCARGAR PDF
            </button>
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="empty-state">
      Todavía no hay presupuestos guardados para este cliente.
    </div>
  }
</div>

<!-- MODAL DE EDICIÓN -->
<div class="modal fade" id="editarPresupuestoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">Editar Presupuesto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      @if (presupuestoEditando) {
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre del presupuesto</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="presupuestoEditando.name"
              placeholder="Nombre del presupuesto"
            />
          </div>

          <div class="mb-3">
            <strong>Cliente:</strong> {{ presupuestoEditando.cliente.name || 'Sin cliente' }}
          </div>

          <!-- LISTA DE TAREAS EDITABLES -->
          <div class="mb-3">
            <strong>Tareas asociadas ({{ presupuestoEditando.tareas.length || 0 }})</strong>
            @if (presupuestoEditando.tareas.length > 0) {
              <div class="table-responsive mt-2">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Tarea</th>
                      <th>Costo</th>
                      <th>Área</th>
                      <th>Total</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (tarea of presupuestoEditando.tareas; track tarea.id; let i = $index) {
                      <tr>
                        <td>{{ tarea.tarea }}</td>
                        <td>${{ tarea.costo | number:'1.2-2' }}</td>
                        <td>{{ tarea.area }}</td>
                        <td>${{ tarea.totalCost | number:'1.2-2' }}</td>
                        <td>
                          <button class="btn btn-sm btn-danger" (click)="quitarTareaEdicion(i)">
                            Quitar
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <p class="text-muted mt-2">No hay tareas asociadas</p>
            }
          </div>

          <div class="mt-4 border-top pt-4">
  <h6 class="fw-bold mb-3">Agregar tarea del cliente</h6>
  <div class="input-group">
    <select
    class="form-select"
    [(ngModel)]="tareaAAgregarId"
    (change)="onTareaSeleccionadaChange()">
      <option [ngValue]="null">Seleccionar tarea...</option>
      @for (tarea of tareasDisponiblesParaAgregar; track tarea.id) {
        <option [ngValue]="tarea.id">
          {{ tarea.tarea }} - ${{ tarea.costo | number:'1.2-2' }} (Total: ${{ tarea.totalCost | number:'1.2-2' }})
        </option>
      }
    </select>
    <button
      class="btn btn-success ms-2"
      (click)="agregarTareaAlPresupuesto()"
      [disabled]="!tareaAAgregarId"
    >
      Agregar
    </button>
  </div>
</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button
            type="button"
            class="btn btn-warning"
            (click)="confirmarEdicion()"
            [disabled]="!presupuestoEditando.name.trim()"
          >
            Guardar cambios
          </button>
        </div>
      } @else {
        <div class="modal-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      }
    </div>
  </div>
</div>
