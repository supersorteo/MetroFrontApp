<button class="btn btn-primary floating-menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
  <i class="bi bi-list"></i>
</button>

  <div class="fixed-image-container">
    <img id="fixedImageIcon" class="fixed-image" src="#" alt="Logo Empresa" style="display: none;">
  </div>


<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel"
  (shown.bs.offcanvas)="isSidebarOpen = true" (hidden.bs.offcanvas)="isSidebarOpen = false">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasMenuLabel">Opciones</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="weather-widget mb-3 w-100 text-center">
      <h6 class="mb-2">Clima actual</h6>
      <div *ngIf="weatherLoading" class="text-muted">Cargando...</div>
      <div *ngIf="weatherError && !weatherLoading" class="text-danger small">{{ weatherError }}</div>
      <div *ngIf="currentWeather && !weatherLoading">
        <div class="weather-temp">{{ currentWeather.temperature | number:'1.0-0' }}°C</div>
        <div class="weather-desc">{{ weatherDescription(currentWeather.weathercode) }}</div>
        <small class="text-muted d-block">{{ currentWeather.location }}</small>
        <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#weatherModal" (click)="loadWeather()">
          Ver pronóstico
        </button>
      </div>
    </div>
    <ul class="list-unstyled d-flex flex-column align-items-center">
      <li class="w-100 mb-3 text-center timer-info" style="font-size: 18px; font-weight: bold; color: #092865; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
        {{ remainingTime }}
      </li>
    
      <li class="w-100 mt-3">
        <button (click)="abrirGoogleSheets2()" id="mano-de-obra-button2" class="btn btn-primary btn-block animate w-100">PDF valor vivienda JULIO/2025</button>
      </li>
      <li class="w-100 d-flex flex-column gap-2 mt-2">
        <button class="btn btn-primary btn-block w-100 animate">BONOS TEMU</button>
        <button class="btn btn-primary btn-block w-100 animate">BIBLIOTECA</button>
      </li>
        <li class="w-100 text-center">
        <button class="btn btn-secondary logout-button1 w-100" (click)="logout()">cerrar session</button>
      </li>
    </ul>
  </div>
</div>


<div class="dashboard-container">

  <div id="successAlert" style="display: none;" class="alert alert-success">Datos guardados</div>



  <div class="card dashboard-card">

    <div class="program-title" id="portada" style="border-radius: 10px;" *ngIf="!isContentVisible">
      <h6 style="font-size: 12px; margin-bottom: 0px;">Orbita software</h6>
    </div>

    <!-- Segunda tarjeta: Botones Empresa y Cliente verticales -->
    <div class="card mb-3 w-100">
      <div class="card-body d-flex flex-column gap-2 px-2">
  <button class="btn btn-primary btn-block  w-100 animate " data-bs-toggle="modal" data-bs-target="#exampleModal" (click)="cargarDatosEmpresaSeleccionada()">DATOS DE TU EMPRESA</button>
  <!--ng-select--
    [items]="empresas"
    bindLabel="name"
    bindValue="id"
    [(ngModel)]="selectedEmpresaId"
    placeholder="Selecciona una empresa"
    (change)="onEmpresaSeleccionada($event)"
    [clearable]="false"
    class="form-select w-100 animate"
    [ngClass]="{'is-invalid': !selectedEmpresaId}"
    style="height: 40px; font-weight: bold; font-size: 16px; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
    <ng-template ng-option-tmp let-item="item" let-selected="selected">
      <img *ngIf="item.logoUrl" [src]="item.logoUrl" width="24" class="me-2" style="object-fit:cover; border-radius:50%;">
      {{ item.name }}
      <span *ngIf="selected" class="float-end text-success"><i class="bi bi-check-lg"></i></span>
    </ng-template>
  </!--ng-select-->

  	<!--ng-select
		[items]="empresas"
		bindLabel="name"
		bindValue="id"
		[(ngModel)]="selectedEmpresaId"
		(change)="onEmpresaSeleccionada($event)"
		[ngClass]="{'is-invalid': !selectedEmpresaId}"
		placeholder="Selecciona una empresa"
		[clearable]="false"
     style="height: 40px; font-weight: bold; font-size: 16px; border-radius: 15px; box-shadow: 0 2px 8px #0001;"
    >
		<ng-template ng-option-tmp let-item="item" let-selected="selected">
      <img *ngIf="item.logoUrl" [src]="item.logoUrl" width="24" class="me-2" style="object-fit:cover; border-radius:50%;">
      {{ item.name }}
      <span *ngIf="selected" class="float-end text-success"><i class="bi bi-check-lg"></i></span>
    </ng-template>
	</ng-select-->


<!--ng-select--
  [items]="clientes"
  bindLabel="name"
  [(ngModel)]="clienteSeleccionado"
  (ngModelChange)="loadTareasAgregadas()"
  [ngClass]="{'is-invalid': !clienteSeleccionado}"
  placeholder="Selecciona un cliente"
  [clearable]="false"
  style="height: 40px; font-weight: bold; font-size: 16px; border-radius: 15px; box-shadow: 0 2px 8px #0001;"
>
  <ng-template ng-option-tmp let-item="item" let-selected="selected">
    <span>{{ item.name }}</span>
    <span *ngIf="selected" class="float-end text-success"><i class="bi bi-check-lg"></i></span>
  </ng-template>
</!--ng-select-->

<!-- Modal Lista de Empresas -->

  <!-- <button class="btn btn-primary btn-block  w-100 animate" data-bs-toggle="modal" data-bs-target="#clientModal">DATOS DEL CLIENTE</button> -->
  <button class="btn btn-primary btn-block  w-100 animate" data-bs-toggle="modal" data-bs-target="#listaClientesModal">DATOS DEL CLIENTE</button>
      </div>
    </div>

  <h4 class="text-start">Nuevo Presupuesto</h4>
<div class="card table-card mt-2 mb-3">
  <div class="card-body">
    <h5 class="mb-3">Lista de tareas</h5>
    <div class="containerbuscar">
      <div class="search-container">
        <input class="input form-control" placeholder="Buscar tarea..." type="text" id="busqueda" (input)="buscar($event)">
      </div>
    </div>
    <p style="text-align: center;">Si no encuentras una tarea, selecciona TAREA GENERICA y edita su precio y descripción</p>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th style="width:85%; min-width:120px;">Tarea</th>
            <th style="width:15%; min-width:70px; text-align:right;">Costo/$</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tarea of tareasFiltradas; let i = index" (click)="seleccionar(tarea)" class="hoverable-row" [ngClass]="{'lista-tareas-odd-row': i % 2 === 0, 'lista-tareas-even-row': i % 2 !== 0}">
            <td style="width:85%; word-break:break-word; white-space:normal;">{{ tarea.tarea }}</td>
            <td style="width:15%; text-align:right; word-break:break-word; white-space:normal;">{{ tarea.costo | currency:'USD':'symbol':'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="row mt-4">
      <div class="w-100 d-flex justify-content-center mb-2">
        <button type="button" class="btn btn-success animate" style="font-weight:bold; border-radius: 10px; box-shadow: 0 2px 8px #0001;" data-bs-toggle="modal" data-bs-target="#provinciaModal">
          <i class="bi bi-geo-alt"></i> Seleccionar provincia
        </button>
      </div>

      <div class="col">
        <div class="input-group" style="padding:5px; margin: 2px; z-index: 0;">
          <input type="text" class="form-control" placeholder="%" [(ngModel)]="porcentajeBajar">
          <div class="input-group-append">
            <button class="btn btn-danger w-100" (click)="disminuirPrecios()">Bajar</button>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="input-group" style="padding:5px; margin: 2px; z-index: 0;">
          <input type="text" class="form-control" placeholder="%" [(ngModel)]="porcentajeSubir">
          <div class="input-group-append">
            <button class="btn btn-success w-100" (click)="ajustarPrecios()">Subir</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




<div *ngIf="mostrarTabla" class="container mt-4 tareas-agregadas">
  <div class="tareas-agregadas__header">
    <h5 class="text-primary tareas-agregadas__title">TAREAS A REALIZAR</h5>
    <div class="tareas-agregadas__cliente" *ngIf="clienteSeleccionado">
      <span class="tareas-agregadas__cliente-nombre">{{ clienteSeleccionado.name }}</span>
      <small class="tareas-agregadas__cliente-fecha" *ngIf="budgetDate">
        Presupuesto: {{ budgetDate | date:'dd/MM/yyyy' }}
      </small>
    </div>
  </div>
  <div class="table-responsive tareas-table-wrapper">
    <table class="table table-striped table-hover tareas-table">
      <thead class="thead-light">
        <tr>
          <th class="text-center">Acciones</th>
          <th class="text-center">Tarea</th>
          <!--th-- class="text-center">Rubro</!--th-->
          <!--th-- class="text-center">Categoría</!--th-->
          <!--th class="text-center">Descripción</!--th-->
          <th class="text-center">Área (m²/m³)</th>
          <th class="text-center">Costo</th>
          <th class="text-center">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tarea of tareasAgregadas; let i = index">
          <td class="text-center">
            <button *ngIf="tarea.id" (click)="eliminarTarea(tarea.id)" class="btn btn-outline-danger btn-sm rounded-circle">X</button>
          </td>
          <td>{{ tarea.tarea }}</td>
          <!--td>{{ tarea.rubro }}</td-->
          <!--td>{{ tarea.categoria }}</!--td-->
          <!--td>{{ tarea.descripcion }}</td-->
          <td>{{ tarea.area | number:'1.2-2' }}</td>
          <td>{{ tarea.costo | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>{{ tarea.totalCost | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="tareas-total mt-3">
    Total: {{ calcularCostoTotal() | currency:'USD':'symbol':'1.2-2' }}
  </div>
  <div class="tareas-guardar mt-3">
    <button class="btn btn-secondary guardar-btn" (click)="toggleSavedBudgetsPanel()">
      Guardar presupuesto
    </button>
  </div>
</div>

</div>

</div>


  <div class="modal fade" id="miModal" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel1">Agregar Tarea</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <!--label-- for="tarea" class="col-form-label">Tarea:</!--label-->
                <textarea [(ngModel)]="tareaSeleccionada.tarea" name="tarea" class="form-control" rows="3"
                  style="margin-bottom: 20px; font-size: 14px; white-space: pre-wrap; overflow-wrap: break-word; background-image: linear-gradient(to top, #c7d0e9, #d7dbee, #e5e7f4, #f3f3f9, #ffffff); color: #092865; padding: 10px; resize: none; font-weight: bold;"
                  readonly></textarea>
              </div>
              <!--div class="mb-3">
                <label for="rubro" class="col-form-label">Rubro:</label>
                <input type="text" [(ngModel)]="tareaSeleccionada.rubro" name="rubro" class="form-control" id="rubro" readonly>
              </div-->
              <!--div-- class="mb-3">
                <label for="categoria" class="col-form-label">Categoría:</label>
                <input type="text" [(ngModel)]="tareaSeleccionada.categoria" name="categoria" class="form-control" id="categoria" readonly>
              </!div-->
              <div class="row mb-3">
                <div class="col-6">
                  <label for="area" class="col-form-label">Área (m²/m³):</label>
                  <input type="number" [(ngModel)]="tareaSeleccionada.area" name="area" class="form-control" id="area" placeholder="Ingresa el área" required>
                </div>
                <div class="col-6">
                  <label for="modal-cost" class="col-form-label">Costo por m²/m³/ml:</label>
                  <input type="number" [(ngModel)]="tareaSeleccionada.costo" name="costo" class="form-control" id="cost"
                    style="color: #ab1444; font-weight: bold; text-align: center;" placeholder="Ingresa el costo" step="0.01" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="description" class="col-form-label">Descripción:</label>
                <input type="textarea" [(ngModel)]="tareaSeleccionada.descripcion" name="descripcion" class="form-control" id="description" placeholder="Es opcional">
              </div>
              <div class="mb-3">
                <label for="discount" class="col-form-label">Descuento (%):</label>
                <input type="number" [(ngModel)]="tareaSeleccionada.descuento" name="descuento" class="form-control" id="discount" value="0">
              </div>
              <div class="modal-footer">
                <!--button-- type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</!button-->
                <button type="button" (click)="agregarTarea()" class="btn btn-primary" data-bs-dismiss="modal">Agregar</button>
                <!--button-- type="button" *ngIf="tareaSeleccionada.id" (click)="actualizarTarea()" class="btn btn-primary" data-bs-dismiss="modal">Actualizar</!--button-->
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true"  >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientModalLabel">Formulario de Datos del Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h2 id="confirmationMessage" style="display: none; color: green; text-align: center;">Datos guardados</h2>
        <form #clientForm="ngForm" (ngSubmit)="saveClientData(clientForm)">
          <div class="form-group mb-3">
            <!--label for="clientName">Nombre:</!--label-->
            <input type="text" class="form-control" id="clientName" name="clientName" [(ngModel)]="clientName" required minlength="2" placeholder="Nombre del cliente" #name="ngModel">
            @if (name.touched && name.errors?.['required']) {
              <div class="text-danger">El nombre es obligatorio.</div>
            }
            @if (name.touched && name.errors?.['minlength']) {
              <div class="text-danger">El nombre debe tener al menos 2 caracteres.</div>
            }
          </div>
          <div class="form-group mb-3">
            <!--label for="contact">Contacto:</!--label-->
            <input type="text" class="form-control" id="contact" name="clientContact" [(ngModel)]="clientContact" required pattern="\+?\d{7,15}" placeholder="Teléfono" #contact="ngModel">
            @if (contact.touched && contact.errors?.['required']) {
              <div class="text-danger">El contacto es obligatorio.</div>
            }
            @if (contact.touched && contact.errors?.['pattern']) {
              <div class="text-danger">El contacto debe ser un número de teléfono válido (7-15 dígitos, puede incluir +).</div>
            }
          </div>
          <div class="form-group mb-3">
            <!--label for="email">Email:</!--label-->
            <input type="email" class="form-control" id="email" name="clientEmail" [(ngModel)]="clientEmail" required email placeholder="Email" #email="ngModel">
            @if (email.touched && email.errors?.['required']) {
              <div class="text-danger">El email es obligatorio.</div>
            }
            @if (email.touched && email.errors?.['email']) {
              <div class="text-danger">El email debe tener un formato válido.</div>
            }
          </div>
          <div class="form-group mb-3">
            <!--label-- for="clave">CUIT/Clave:</!--label-->
            <input type="text" class="form-control" id="clave" name="clientClave" [(ngModel)]="clientClave"  pattern="\d{2}-\d{8}-\d{1}" placeholder="CUIT/Clave" #clave="ngModel">

            @if (clave.touched && clave.errors?.['pattern']) {
              <div class="text-danger">El CUIT debe tener el formato XX-XXXXXXXX-X.</div>
            }
          </div>
          <div class="form-group mb-3">
            <!--label for="direccion">Dirección:</!--label-->
            <input type="text" class="form-control" id="direccion" name="clientDireccion" [(ngModel)]="clientDireccion" required minlength="5" placeholder="Dirección" #direccion="ngModel">
            @if (direccion.touched && direccion.errors?.['required']) {
              <div class="text-danger">La dirección es obligatoria.</div>
            }
            @if (direccion.touched && direccion.errors?.['minlength']) {
              <div class="text-danger">La dirección debe tener al menos 5 caracteres.</div>
            }
          </div>
          <div class="form-group mb-3">
            <label for="budgetDate">Fecha del Presupuesto:</label>
            <input type="date" class="form-control" id="budgetDate" name="budgetDate" [(ngModel)]="budgetDate" required #budgetDateCtrl="ngModel"  (change)="onDateChange($event)">
            @if (budgetDate.touched && budgetDate.errors?.['required']) {
              <div class="text-danger">La fecha del presupuesto es obligatoria.</div>
            }
          </div>
          <div class="form-group mb-3">
            <!--label for="additionalDetails">Detalles Adicionales:</!--label-->
            <textarea class="form-control" id="additionalDetails" name="additionalDetailsClient" [(ngModel)]="additionalDetailsClient" rows="3" placeholder="Detalles opcionales"></textarea>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <!--button-- type="button" class="btn btn-secondary" data-bs-target="#listaClientesModal" data-bs-toggle="modal">Lista</!--button-->
            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal" [disabled]="!clientForm.valid || isSavingClient">
              <span *ngIf="!isSavingClient">Guardar</span>
              <span *ngIf="isSavingClient"><span class="spinner-border spinner-border-sm"></span> Guardando...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>




<!--div-- class="modal fade" id="listaClientesModal" aria-hidden="true" aria-labelledby="listaClientesLabel" tabindex="-1" (shown.bs.modal)="getClientesByUserCode()">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="listaClientesLabel">Lista de Clientes Asociados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover table-sm">
            <thead class="table-light">
              <tr>
                <th scope="col">Nombre</th>
                <th scope="col">Contacto</th>
                <th scope="col">Email</th>
                <th scope="col">CUIT/Clave</th>
                <th scope="col">Dirección</th>
                <th scope="col">Fecha</th>
                <th scope="col">Detalles</th>
                <th scope="col">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cliente of paginatedClientes">
                <td>{{ cliente.name }}</td>
                <td>{{ cliente.contact }}</td>
                <td>{{ cliente.email }}</td>
                <td>{{ cliente.clave }}</td>
                <td>{{ cliente.direccion }}</td>
                <td>{{ cliente.budgetDate }}</td>
                <td>{{ cliente.additionalDetails }}</td>
                <td>
                  <div class="d-flex gap-2">
                    <button class="btn btn-danger btn-sm" (click)="cliente.id && solicitarConfirmacionEliminar(cliente.id)">Eliminar</button>
                    <button class="btn btn-success btn-sm" *ngIf="cliente.id !== undefined" (click)="editarCliente(cliente.id)">Editar</button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="paginatedClientes.length === 0">
                <td colspan="8" class="text-center">No hay clientes asociados a este userCode.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <nav aria-label="Paginación de clientes" *ngIf="clientes.length > itemsPerPage">
          <ul class="pagination justify-content-center flex-wrap">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="previousPage()" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <li class="page-item" *ngFor="let page of getPages()" [class.active]="currentPage === page">
              <a class="page-link" (click)="setPage(page)">{{ page }}</a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <a class="page-link" (click)="nextPage()" aria-label="Siguiente">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</!--div-->



<div class="modal fade" id="listaClientesModal" aria-hidden="true" aria-labelledby="listaClientesLabel" tabindex="-1" (shown.bs.modal)="onEmpresaSeleccionada(selectedEmpresaId)">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="listaClientesLabel">Lista de Clientes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row mb-3">
            <div class="col-12 d-flex flex-wrap align-items-center gap-3">
              <ng-select
                [items]="clientes"
                bindLabel="name"
                [(ngModel)]="clienteSeleccionado"
                (ngModelChange)="seleccionarCliente($event); loadTareasAgregadas()"
                [ngClass]="{'is-invalid': !clienteSeleccionado}"
                placeholder="Selecciona un cliente"
                [clearable]="false"
                style="height: 40px; font-weight: bold; font-size: 16px; border-radius: 15px; box-shadow: 0 2px 8px #0001; min-width: 220px;"
              >
                <ng-template ng-option-tmp let-item="item" let-selected="selected">
                  <span>{{ item.name }}</span>
                  <span *ngIf="selected" class="float-end text-success"><i class="bi bi-check-lg"></i></span>
                </ng-template>
              </ng-select>
              <input type="text" class="form-control w-auto" placeholder="Filtrar cliente..." [(ngModel)]="filtroCliente" style="max-width: 250px;">
            </div>
          </div>
          <div class="row">
            <div class="col-12" *ngFor="let cliente of paginatedClientes | filterCliente:filtroCliente">
              <div class="card mb-3 w-100 shadow-sm"
              style="width: 100%; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.25), 0 1.5px 8px rgba(50,50,105,0.25); border: 2.5px solid #4b5154;"
              >
                <div class="card-body position-relative">
                  <h5 class="card-title" style="font-size: 1.2rem; font-weight: bold;">{{ cliente.name }}</h5>
                  <p class="card-text mb-1"><strong>Tel:</strong> {{ cliente.contact }}</p>
                  <p class="card-text mb-1"><strong>Email:</strong> {{ cliente.email }}</p>
                  <p class="card-text mb-1"><strong>CUIT/Clave:</strong> {{ cliente.clave }}</p>
                  <p class="card-text mb-1"><strong>Dirección:</strong> {{ cliente.direccion }}</p>
                  <p class="card-text mb-1"><strong>Fecha:</strong> {{ cliente.budgetDate }}</p>
                  <p class="card-text mb-2"><strong>Detalles:</strong> {{ cliente.additionalDetails }}</p>
                  <div class="d-flex justify-content-end gap-1 mt-2">
                    <button class="btn btn-danger btn-xs px-3 py-1" style="font-size: 0.85rem; min-width: 80px;" (click)="cliente.id && solicitarConfirmacionEliminar(cliente.id)">Eliminar</button>
                    <span style="width: 10px;"></span>
                    <button class="btn btn-success btn-xs px-3 py-1" style="font-size: 0.85rem; min-width: 80px;" *ngIf="cliente.id !== undefined" (click)="editarCliente(cliente.id)">Editar</button>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="paginatedClientes.length === 0" class="col-12 text-center text-muted py-3">
              No hay clientes asociados a este userCode.
            </div>
          </div>
        </div>
        <!-- Controles de paginación -->
        <nav aria-label="Paginación de clientes" *ngIf="clientes.length > itemsPerPage">
          <ul class="pagination justify-content-center flex-wrap">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="previousPage()" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <li class="page-item" *ngFor="let page of getPages()" [class.active]="currentPage === page">
              <a class="page-link" (click)="setPage(page)">{{ page }}</a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <a class="page-link" (click)="nextPage()" aria-label="Siguiente">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#clientModal">Crear nuevo cliente</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Agregar datos de tu Empresa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 10px; background-image: linear-gradient(to top, #ffffff, #fafafd, #f4f6fc, #edf3fb, #e5eff9); border-radius: 10px; box-shadow: rgba(0, 0, 0, 0.18) 0px 2px 4px;">
        <p style="text-align: center; font-size: 12px;">
          Podés editar estos datos las veces que quieras.
        </p>
        <div class="row g-2 align-items-end mb-3">
          <div class="col">
            <label for="empresaName">Tu Empresa/nombre personal</label>
            <input type="text" class="form-control" id="empresaName" [(ngModel)]="empresaName" placeholder="¿Cómo se llama?">
          </div>
          <div class="col-auto d-flex align-items-end">
            <button class="btn btn-primary w-100" type="button" (click)="abrirModalImagen()">Subir imagen</button>
          </div>
        </div>
        <div class="form-group mb-3">
          <label for="empresaPhone">Tel:</label>
          <input type="text" class="form-control" id="empresaPhone" [(ngModel)]="empresaPhone" placeholder="Teléfono de tu empresa">
        </div>
        <div class="form-group mb-3">
          <label for="empresaEmail">Email:</label>
          <input type="email" class="form-control" id="empresaEmail" [(ngModel)]="empresaEmail" placeholder="Email de tu empresa">
        </div>
        <div class="form-group mb-3">
          <label for="additionalDetailsempresa">Descripción:</label>
          <textarea class="form-control" id="additionalDetailsempresa" [(ngModel)]="additionalDetailsEmpresa" rows="3" placeholder="Cuenta a tus clientes de qué se trata tu empresa"></textarea>
        </div>
        <div class="form-group mb-3">
          <label for="empresaWebsite">Sitio web (opcional)</label>
          <input type="url" class="form-control" id="empresaWebsite" [(ngModel)]="empresaWebsite" placeholder="https://..." />
        </div>
        <div class="form-group mb-3">
          <label for="empresaCuilCuit">CUIL/CUIT (opcional)</label>
          <input type="text" class="form-control" id="empresaCuilCuit" [(ngModel)]="empresaCuilCuit" placeholder="00-00000000-0" />
        </div>
        <hr>
       <div>
         <button type="button" class="btn btn-outline-primary mb-3" (click)="toggleSocialFields()">
          {{ showSocialFields ? 'Ocultar redes' : 'Redes' }}
        </button>
       </div>
        <div *ngIf="showSocialFields">
          <div class="form-group mb-3">
            <label for="empresaTikTok">TikTok (opcional)</label>
            <input type="text" class="form-control" id="empresaTikTok" [(ngModel)]="empresaTikTok" placeholder="@tuusuario o enlace" />
          </div>
          <div class="form-group mb-3">
            <label for="empresaInstagram">Instagram (opcional)</label>
            <input type="text" class="form-control" id="empresaInstagram" [(ngModel)]="empresaInstagram" placeholder="@tuusuario o enlace" />
          </div>
          <div class="form-group mb-3">
            <label for="empresaFacebook">Facebook (opcional)</label>
            <input type="text" class="form-control" id="empresaFacebook" [(ngModel)]="empresaFacebook" placeholder="URL de tu pagina" />
          </div>
        </div>
     

      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" (click)="openListaEmpresasModal()">Seleccionar empresa</button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" (click)="saveFormData()">Guardar</button>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="listaEmpresasModal" aria-hidden="true" aria-labelledby="listaEmpresasLabel" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="listaEmpresasLabel">Lista de Empresas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Vista nueva con filtro y ng-select -->
        <div class="container-fluid">
          <div class="row mb-3">
            <div class="col-12 d-flex flex-wrap align-items-center gap-3">
              <ng-select
                [items]="empresas"
                bindLabel="name"
                bindValue="id"
                [(ngModel)]="selectedEmpresaId"
                (change)="onEmpresaSeleccionada($event)"
                [ngClass]="{'is-invalid': !selectedEmpresaId}"
                placeholder="Selecciona una empresa"
                [clearable]="false"
                style="height: 40px; font-weight: bold; font-size: 16px; border-radius: 15px; box-shadow: 0 2px 8px #0001; min-width: 220px;"
              >
                <ng-template ng-option-tmp let-item="item" let-selected="selected">
                  <img *ngIf="item.logoUrl" [src]="item.logoUrl" width="24" class="me-2" style="object-fit:cover; border-radius:50%;">
                  {{ item.name }}
                  <span *ngIf="selected" class="float-end text-success"><i class="bi bi-check-lg"></i></span>
                </ng-template>
              </ng-select>
              <input type="text" class="form-control w-auto" placeholder="Filtrar empresa..." [(ngModel)]="filtroEmpresa" style="max-width: 250px;">
            </div>
          </div>
          <div class="row">
            <div class="col-12" *ngFor="let empresa of paginatedEmpresas | filterEmpresa:filtroEmpresa">
              <div class="card mb-3 w-100 shadow-sm"
                style="width: 100%; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.25), 0 1.5px 8px rgba(50,50,105,0.25); border: 2.5px solid #4b5154;"
              >
                <div class="card-body position-relative">
                  <h5 class="card-title" style="font-size: 1.2rem; font-weight: bold;">
                    {{ empresa.name }}
                    <img *ngIf="empresa.logoUrl" [src]="empresa.logoUrl" alt="Logo" style="width:32px;height:32px;object-fit:cover;float:right;border-radius:50%;margin-left:10px;">
                  </h5>
                  <p class="card-text mb-1"><strong>Tel:</strong> {{ empresa.phone }}</p>
                  <p class="card-text mb-1"><strong>Email:</strong> {{ empresa.email }}</p>
                  <p class="card-text mb-1"><strong>Descripción:</strong> {{ empresa.description }}</p>
                  <div class="d-flex justify-content-end gap-1 mt-2">
                    <button class="btn btn-danger btn-xs px-3 py-1" style="font-size: 0.85rem; min-width: 80px;" (click)="empresa.id && solicitarConfirmacionEliminarEmpresa(empresa.id)">Eliminar</button>
                    <span style="width: 10px;"></span>
                    <button class="btn btn-success btn-xs px-3 py-1" style="font-size: 0.85rem; min-width: 80px;" *ngIf="empresa.id !== undefined" (click)="editarEmpresa(empresa.id)">Editar</button>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="paginatedEmpresas.length === 0" class="col-12 text-center text-muted py-3">
              No hay empresas asociadas a este usuario.
            </div>
          </div>
        </div>
        <!-- Controles de paginación -->
        <nav aria-label="Paginación de empresas" *ngIf="empresas.length > itemsPerPageEmpresas">
          <ul class="pagination justify-content-center flex-wrap">
            <li class="page-item" [class.disabled]="currentEmpresaPage === 1">
              <a class="page-link" (click)="previousEmpresaPage()" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            <li class="page-item" *ngFor="let page of getEmpresaPages()" [class.active]="currentEmpresaPage === page">
              <a class="page-link" (click)="setEmpresaPage(page)">{{ page }}</a>
            </li>
            <li class="page-item" [class.disabled]="currentEmpresaPage === totalEmpresaPages">
              <a class="page-link" (click)="nextEmpresaPage()" aria-label="Siguiente">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          </ul>
        </nav>
        <!-- Tabla original comentada -->
        <!--
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover table-sm">
            <thead class="table-light">
              <tr>
                <th scope="col">Nombre</th>
                <th scope="col">Teléfono</th>
                <th scope="col">Email</th>
                <th scope="col">Descripción</th>
                <th scope="col">Logo</th>
                <th scope="col">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let empresa of paginatedEmpresas">
                <td>{{ empresa.name }}</td>
                <td>{{ empresa.phone }}</td>
                <td>{{ empresa.email }}</td>
                <td>{{ empresa.description }}</td>
                <td>
                  <img *ngIf="empresa.logoUrl" [src]="empresa.logoUrl" alt="Logo" style="width:40px;height:40px;object-fit:cover;">
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <button class="btn btn-danger btn-sm" (click)="empresa.id && solicitarConfirmacionEliminarEmpresa(empresa.id)">Eliminar</button>
                    <button class="btn btn-success btn-sm" *ngIf="empresa.id !== undefined" (click)="editarEmpresa(empresa.id)">Editar</button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="paginatedEmpresas.length === 0">
                <td colspan="6" class="text-center">No hay empresas asociadas a este usuario.</td>
              </tr>
            </tbody>
          </table>
        </div>
        -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<div class="floating-toolbar-container" *ngIf="!isSidebarOpen">
  <div class="floating-toolbar">
    <button class="btn btn-primary toolbar-btn" (click)="verPresupuesto()">VER PRESUPUESTO</button>
    <button class="btn btn-secondary toolbar-btn" (click)="toggleSavedBudgetsPanel()">GUARDAR PRESUPUESTO</button>
  </div>
</div>

<div class="saved-budgets-overlay" *ngIf="showSavedBudgetsPanel" (click)="closeSavedBudgetsPanel()"></div>

<div class="saved-budgets-panel" [class.open]="showSavedBudgetsPanel">
  <div class="panel-header">
    <h5 class="mb-0">Presupuestos guardados</h5>
    <button type="button" class="btn-close" (click)="closeSavedBudgetsPanel()" aria-label="Cerrar"></button>
  </div>
  <app-presupuestos-guardados
    [tareasActuales]="tareasAgregadas"
    [clienteActual]="clienteSeleccionado"
    [empresaActual]="selectedEmpresaId"
    (cargarPresupuesto)="onCargarPresupuestoGuardado($event)">
  </app-presupuestos-guardados>
</div>

<div class="modal fade" id="weatherModal" tabindex="-1" aria-labelledby="weatherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="weatherModalLabel">Próximos 5 días</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="dailyForecast.length; else noWeatherData">
          <div class="row g-3">
            <div class="col-12 col-sm-6" *ngFor="let day of dailyForecast">
              <div class="forecast-card p-3 h-100">
                <div class="fw-bold">{{ day.date | date:'EEEE d MMM' }}</div>
                <div class="text-muted small">{{ weatherDescription(day.code) }}</div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <span class="text-primary fw-bold">Máx: {{ day.max | number:'1.0-0' }}°C</span>
                  <span class="text-secondary">Mín: {{ day.min | number:'1.0-0' }}°C</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noWeatherData>
          <p class="text-center text-muted mb-0">No hay datos disponibles en este momento.</p>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" >
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Subir Imagen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div id="imageCircle" style="display: flex; justify-content: center;">
          <img #modalImagePreview class="img-fluid" src="#" alt="Previsualización de la imagen" style="display: none; width: 80%; height: 80%;">
        </div>
        <p #uploadMessage style="margin-top: 10px; color: rgb(6, 113, 254); display: none;">Imagen subida</p>
        <input type="file" #imageInput accept="image/*" class="form-control" style="margin-top: 10px;" (change)="onImageChange($event)">
        <p>formato cuadrado recomendado</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="uploadImage()" [disabled]="!imageSelected" >Cargar Imagen</button>
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
      </div>
    </div>
  </div>
</div>


 <!-- Modal Seleccionar provincia -->
    <div class="modal fade provincia-modal" id="provinciaModal" tabindex="-1" aria-labelledby="provinciaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <div>
              <p class="text-uppercase text-muted mb-1 small">Configuración</p>
              <h1 class="modal-title fs-5 fw-bold" id="provinciaModalLabel">Seleccionar provincia</h1>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <label for="selectProvincia" class="form-label fw-semibold">Provincia</label>
              <select id="selectProvincia" class="form-select form-select-lg" [(ngModel)]="provinciaSeleccionada" name="provinciaSeleccionada">
                <option value="" disabled selected>Seleccione una provincia</option>
                <option *ngFor="let provincia of provincias" [value]="provincia.nombre">{{ provincia.nombre }}</option>
              </select>
            </div>
            <div *ngIf="provincias.length === 0" class="text-muted text-center py-3">No hay provincias disponibles para el país seleccionado.</div>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary px-4">Guardar</button>
          </div>
        </div>
      </div>
    </div>





